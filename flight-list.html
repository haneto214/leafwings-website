<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>フライト選択 | LEAF WINGS</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- 共通設定 --- */
        :root { --leaf-mint: #00C9A7; --leaf-sky: #4FACFE; --pure-white: #FFFFFF; --accent-gray: #F0F4F8; --text-dark: #2C3E50; --text-light: #8898aa; }
        body, html { margin: 0; padding: 0; font-family: "Montserrat", "Noto Sans JP", sans-serif; background-color: var(--accent-gray); color: var(--text-dark); line-height: 1.6; }
        
        header { background: linear-gradient(90deg, var(--leaf-mint), var(--leaf-sky)); padding: 15px 40px; color: var(--pure-white); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logo { font-size: 20px; font-weight: 700; display: flex; align-items: center; letter-spacing: 0.1em; }
        .logo-icon { width: 24px; height: 24px; background-color: var(--pure-white); border-radius: 50%; margin-right: 10px; position: relative; }
        .logo-icon::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 10px solid var(--leaf-mint); }
        
        .step-indicator { display: flex; gap: 20px; font-size: 12px; opacity: 0.9; }
        .step.active { font-weight: 700; border-bottom: 2px solid var(--pure-white); padding-bottom: 2px; }

        /* 選択済みフライト表示バー */
        .selected-summary { background-color: #2c3e50; color: white; padding: 15px 0; display: none; animation: slideDown 0.3s ease; }
        .selected-content { max-width: 1000px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .selected-label { background: var(--leaf-mint); padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; margin-right: 10px; }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }

        .search-summary-bar { background-color: var(--pure-white); padding: 15px 0; border-bottom: 1px solid #ddd; }
        .container { max-width: 1000px; margin: 0 auto; padding: 0 20px; }
        .summary-content { display: flex; justify-content: space-between; align-items: center; }
        
        .direction-badge { font-size: 12px; font-weight: 700; color: var(--leaf-sky); border: 1px solid var(--leaf-sky); padding: 3px 10px; border-radius: 20px; margin-right: 10px; text-transform: uppercase; }
        .direction-badge.inbound { color: #e67e22; border-color: #e67e22; }

        .route-info { font-size: 18px; font-weight: 700; display: flex; align-items: center; }
        .route-arrow { color: var(--leaf-mint); margin: 0 10px; font-size: 14px; }

        .date-strip { display: flex; justify-content: space-between; background: var(--pure-white); margin-top: 20px; padding: 10px; border-radius: 4px; overflow-x: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .date-card { flex: 1; min-width: 80px; text-align: center; padding: 10px 5px; cursor: pointer; border-radius: 4px; }
        .date-card:hover { background-color: #f9f9f9; }
        .date-card.active { background-color: var(--leaf-mint); color: var(--pure-white); font-weight: bold; }
        .date-card .day { font-size: 12px; margin-bottom: 5px; }
        .date-card .price { font-size: 13px; font-weight: 700; }

        .flight-list { margin-top: 20px; padding-bottom: 80px; }
        .flight-card { background-color: var(--pure-white); border-radius: 8px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid transparent; transition: 0.3s; overflow: hidden; }
        .flight-card:hover { border-color: var(--leaf-sky); transform: translateY(-2px); }
        .flight-info-row { padding: 25px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px; border-bottom: 1px solid #eee; }
        .flight-times { display: flex; align-items: center; gap: 30px; flex: 2; min-width: 250px; }
        .time-group { text-align: center; }
        .time { font-size: 24px; font-weight: 700; line-height: 1; }
        .airport { font-size: 12px; color: var(--text-light); margin-top: 5px; font-weight: 500; }
        .duration-line { flex: 1; text-align: center; position: relative; font-size: 11px; color: var(--text-light); }
        .duration-line::after { content: ''; display: block; width: 100%; height: 1px; background: #ddd; position: absolute; top: 50%; z-index: 0; }
        .duration-text { background: var(--pure-white); padding: 0 10px; position: relative; z-index: 1; }
        .flight-meta { display: flex; flex-direction: column; gap: 5px; font-size: 11px; color: var(--text-light); min-width: 80px; }
        .flight-number { font-weight: 700; color: var(--leaf-sky); }

        .fare-selection { display: flex; width: 100%; }
        .fare-box { flex: 1; padding: 20px; text-align: center; cursor: pointer; border-right: 1px solid #eee; transition: 0.2s; position: relative; }
        .fare-box:last-child { border-right: none; }
        .fare-box:hover { background-color: #fafafa; }
        .fare-box.selected { background-color: #eafbf7; }
        .fare-box.selected::before { content: '✔'; position: absolute; top: 10px; left: 10px; color: var(--leaf-mint); font-weight: bold; }
        .class-name { font-size: 12px; font-weight: 700; color: var(--text-light); text-transform: uppercase; margin-bottom: 5px; }
        .fare-price { font-size: 20px; font-weight: 700; }
        .fare-seats { font-size: 11px; color: var(--text-light); margin-top: 5px; }
        .fare-box.premium .class-name { color: #d4af37; }

        @media (max-width: 768px) {
            .flight-info-row { flex-direction: column; align-items: flex-start; }
            .flight-times { width: 100%; }
            .fare-selection { flex-direction: column; }
            .fare-box { border-right: none; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; padding: 15px; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo"><div class="logo-icon"></div>LEAF WINGS</div>
        <div class="step-indicator">
            <span class="step active">1. 便選択</span>
            <span class="step">2. お客様情報</span>
            <span class="step">3. 完了</span>
        </div>
    </header>

    <div class="selected-summary" id="outbound-summary">
        <div class="selected-content">
            <div><span class="selected-label">往路選択済</span> <span id="summary-text">---</span></div>
            <div>✔</div>
        </div>
    </div>

    <div class="search-summary-bar">
        <div class="container summary-content">
            <div class="route-info">
                <span class="direction-badge" id="direction-badge">Outbound 往路</span>
                <span id="display-from">NGO</span> 
                <span class="route-arrow">✈︎</span> 
                <span id="display-to">---</span>
                <span style="font-size: 14px; font-weight: 400; margin-left: 15px; color: #666;" id="display-date">---</span>
            </div>
            <a href="index.html" style="font-size: 12px; color: var(--leaf-mint); border: 1px solid var(--leaf-mint); padding: 5px 15px; border-radius: 20px;">検索変更</a>
        </div>
    </div>

    <div class="container">
        <div class="date-strip" id="date-strip"></div>
        <div class="flight-list" id="flight-list-container"></div>
    </div>

    <script>
        // 状態管理
        let appState = {
            step: 1,
            tripType: 'oneway',
            outboundData: null,
            inboundData: null,
            currentFrom: '',
            currentTo: '',
            currentDate: '' // "YYYY-MM-DD"
        };

        const airportData = {
            'NGO': { city: '名古屋(中部)' }, 
            'CTS': { city: '札幌(新千歳)', basePrice: 12400 }, 'SDJ': { city: '仙台', basePrice: 11000 }, 'KIJ': { city: '新潟', basePrice: 14000 },
            'FUK': { city: '福岡', basePrice: 13500 }, 'KMJ': { city: '熊本', basePrice: 15200 }, 'KMI': { city: '宮崎', basePrice: 16000 },
            'MYJ': { city: '松山', basePrice: 11500 }, 'OKA': { city: '沖縄(那覇)', basePrice: 18900 },
            'TPE': { city: '台北', basePrice: 35000 }, 'ICN': { city: 'ソウル', basePrice: 28000 }, 'MNL': { city: 'マニラ', basePrice: 42000 }
        };

        // 時刻表データ
        const schedulesOut = {
            'CTS': [{id:'101',d:'07:10',a:'08:50'},{id:'103',d:'11:00',a:'12:40'},{id:'105',d:'15:00',a:'16:40'},{id:'107',d:'19:00',a:'20:40'}],
            'SDJ': [{id:'151',d:'07:15',a:'08:25'},{id:'153',d:'18:00',a:'19:10'}],
            'KIJ': [{id:'181',d:'07:10',a:'08:05'},{id:'183',d:'16:40',a:'17:35'}],
            'FUK': [{id:'301',d:'07:10',a:'08:35'},{id:'303',d:'08:45',a:'10:10'},{id:'305',d:'13:30',a:'14:55'},{id:'307',d:'16:15',a:'17:40'}],
            'KMJ': [{id:'331',d:'07:35',a:'09:00'},{id:'333',d:'18:00',a:'19:25'}],
            'KMI': [{id:'361',d:'13:00',a:'14:20'}],
            'MYJ': [{id:'401',d:'07:30',a:'08:35'},{id:'403',d:'12:15',a:'13:20'}],
            'OKA': [{id:'501',d:'07:10',a:'09:35'},{id:'503',d:'12:00',a:'14:25'},{id:'505',d:'13:25',a:'15:50'}],
            'ICN': [{id:'801',d:'07:10',a:'09:10'},{id:'803',d:'17:00',a:'19:00'}],
            'TPE': [{id:'831',d:'07:10',a:'09:20'},{id:'833',d:'14:00',a:'16:10'}],
            'MNL': [{id:'861',d:'09:30',a:'12:50'}]
        };
        const schedulesIn = {
            'CTS': [{id:'102',d:'09:30',a:'11:15'},{id:'104',d:'13:20',a:'15:05'},{id:'106',d:'17:20',a:'19:05'},{id:'108',d:'21:20',a:'23:05'}],
            'SDJ': [{id:'152',d:'09:05',a:'10:20'},{id:'154',d:'19:50',a:'21:05'}],
            'KIJ': [{id:'182',d:'08:40',a:'09:40'},{id:'184',d:'18:10',a:'19:10'}],
            'FUK': [{id:'302',d:'09:25',a:'10:40'},{id:'304',d:'11:00',a:'12:15'},{id:'306',d:'15:45',a:'17:00'},{id:'308',d:'18:30',a:'19:45'}],
            'KMJ': [{id:'332',d:'09:50',a:'11:05'},{id:'334',d:'20:15',a:'21:30'}],
            'KMI': [{id:'362',d:'15:10',a:'16:25'}],
            'MYJ': [{id:'402',d:'09:25',a:'10:25'},{id:'404',d:'14:10',a:'15:10'}],
            'OKA': [{id:'502',d:'10:25',a:'12:35'},{id:'504',d:'15:15',a:'17:25'},{id:'506',d:'16:40',a:'18:50'}],
            'ICN': [{id:'802',d:'10:10',a:'12:00'},{id:'804',d:'20:00',a:'21:50'}],
            'TPE': [{id:'832',d:'10:20',a:'14:00'},{id:'834',d:'17:10',a:'20:50'}],
            'MNL': [{id:'862',d:'13:50',a:'18:50'}]
        };

        document.addEventListener('DOMContentLoaded', function() {
            const params = new URLSearchParams(window.location.search);
            appState.tripType = params.get('tripType') || 'oneway';
            appState.currentFrom = params.get('from') || 'NGO';
            appState.currentTo = params.get('to') || 'FUK';
            // ここでURLから日付を確実に取得
            appState.currentDate = params.get('depDate') || new Date().toISOString().split('T')[0];

            renderPage();
        });

        function renderPage() {
            document.getElementById('display-from').textContent = appState.currentFrom;
            document.getElementById('display-to').textContent = appState.currentTo;
            
            // 日付表示のフォーマット
            const dObj = new Date(appState.currentDate);
            const dayOfWeek = ['日','月','火','水','木','金','土'][dObj.getDay()];
            document.getElementById('display-date').textContent = `${appState.currentDate.replace(/-/g, '/')} (${dayOfWeek})`;

            const badge = document.getElementById('direction-badge');
            if (appState.step === 1) {
                badge.textContent = 'Outbound 往路';
                badge.className = 'direction-badge';
                document.getElementById('outbound-summary').style.display = 'none';
            } else {
                badge.textContent = 'Inbound 復路';
                badge.className = 'direction-badge inbound';
                document.getElementById('outbound-summary').style.display = 'block';
                document.getElementById('summary-text').textContent = 
                    `${appState.outboundData.from} ✈ ${appState.outboundData.to} / LW${appState.outboundData.id} / ${appState.outboundData.date}`;
            }
            renderFlights();
            renderDateStrip();
        }

        function renderFlights() {
            const container = document.getElementById('flight-list-container');
            container.innerHTML = '';

            let list = [];
            if (appState.currentFrom === 'NGO') list = schedulesOut[appState.currentTo] || [];
            else list = schedulesIn[appState.currentFrom] || [];

            let basePrice = 20000;
            if (appState.step === 1) basePrice = airportData[appState.currentTo]?.basePrice || 20000;
            else basePrice = airportData[appState.currentFrom]?.basePrice || 20000;

            if(list.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">該当するフライトがありません。</div>';
                return;
            }

            list.forEach(flight => {
                const [dh, dm] = flight.d.split(':').map(Number);
                let arrTimeStr = flight.a.split('(')[0]; 
                const [ah, am] = arrTimeStr.split(':').map(Number);
                let dur = (ah * 60 + am) - (dh * 60 + dm);
                if(flight.a.includes('(+1)')) dur += 1440;
                if(dur < 0) dur += 1440;
                const durStr = `${Math.floor(dur/60)}h ${dur%60}m`;

                const std = Math.floor(basePrice * (dh<9?0.9:dh>17?1.1:1.0));
                const pre = Math.floor(std * 2.5);

                const html = `
                <div class="flight-card">
                    <div class="flight-info-row">
                        <div class="flight-times">
                            <div class="time-group"><div class="time">${flight.d}</div><div class="airport">${appState.currentFrom}</div></div>
                            <div class="duration-line"><span class="duration-text">${durStr}</span></div>
                            <div class="time-group"><div class="time">${flight.a}</div><div class="airport">${appState.currentTo}</div></div>
                        </div>
                        <div class="flight-meta"><span class="flight-number">LW ${flight.id}</span><span>A320neo</span><span>Wi-Fi Free</span></div>
                    </div>
                    <div class="fare-selection">
                        <div class="fare-box" onclick="selectFlight('${flight.id}', ${std}, 'Standard')">
                            <div class="class-name">Standard</div><div class="fare-price">¥${std.toLocaleString()}</div>
                        </div>
                        <div class="fare-box premium" onclick="selectFlight('${flight.id}', ${pre}, 'Premium')">
                            <div class="class-name">Premium</div><div class="fare-price">¥${pre.toLocaleString()}</div>
                        </div>
                    </div>
                </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function selectFlight(id, price, cls) {
            const flightData = {
                id: id, price: price, class: cls,
                from: appState.currentFrom, to: appState.currentTo, date: appState.currentDate
            };

            if (appState.step === 1) {
                appState.outboundData = flightData;
                if (appState.tripType === 'round') {
                    // 往復の場合：Step 2へ
                    appState.step = 2;
                    const temp = appState.currentFrom;
                    appState.currentFrom = appState.currentTo;
                    appState.currentTo = temp;
                    
                    // ★重要：復路の日付を取得して現在日にセット
                    const params = new URLSearchParams(window.location.search);
                    appState.currentDate = params.get('retDate') || appState.currentDate;

                    window.scrollTo(0, 0);
                    renderPage();
                } else {
                    finishSelection();
                }
            } else {
                appState.inboundData = flightData;
                finishSelection();
            }
        }

        function finishSelection() {
            const p = new URLSearchParams();
            p.set('tripType', appState.tripType);
            p.set('out_id', appState.outboundData.id);
            p.set('out_price', appState.outboundData.price);
            p.set('out_class', appState.outboundData.class);
            p.set('out_date', appState.outboundData.date); // 日付も渡す
            p.set('from', appState.outboundData.from);
            p.set('to', appState.outboundData.to);
            
            if(appState.inboundData) {
                p.set('in_id', appState.inboundData.id);
                p.set('in_price', appState.inboundData.price);
                p.set('in_date', appState.inboundData.date); // 復路日付も渡す
            }
            
            window.location.href = `passenger.html?${p.toString()}`;
        }

        function renderDateStrip() {
            const el = document.getElementById('date-strip');
            el.innerHTML = '';
            
            // 検索日を基準に前後を表示
            const centerDate = new Date(appState.currentDate);
            
            for(let i=-2; i<=3; i++) {
                const d = new Date(centerDate);
                d.setDate(centerDate.getDate() + i);
                
                const m = d.getMonth()+1;
                const date = d.getDate();
                const w = ['日','月','火','水','木','金','土'][d.getDay()];
                const dayStr = `${m}/${date}(${w})`;
                
                const active = i===0 ? 'active' : '';
                // 簡易的な価格変動演出（土日は高く）
                const isWeekend = (d.getDay()===0 || d.getDay()===6);
                const priceLabel = isWeekend ? "High" : "Low";

                el.innerHTML += `<div class="date-card ${active}"><div class="day">${dayStr}</div><div class="price" style="font-size:10px;">${priceLabel}</div></div>`;
            }
        }
    </script>
</body>
</html>
