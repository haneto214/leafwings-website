<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>フライト選択 | LEAF WINGS</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        /* --- スタイルは今までと同じです（変更なし） --- */
        :root { --leaf-mint: #00C9A7; --leaf-sky: #4FACFE; --pure-white: #FFFFFF; --accent-gray: #F0F4F8; --text-dark: #2C3E50; --text-light: #8898aa; }
        body, html { margin: 0; padding: 0; font-family: "Montserrat", "Noto Sans JP", sans-serif; background-color: var(--accent-gray); color: var(--text-dark); line-height: 1.6; }
        
        header { background: linear-gradient(90deg, var(--leaf-mint), var(--leaf-sky)); padding: 15px 40px; color: var(--pure-white); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logo { font-size: 20px; font-weight: 700; display: flex; align-items: center; letter-spacing: 0.1em; }
        .logo-icon { width: 24px; height: 24px; background-color: var(--pure-white); border-radius: 50%; margin-right: 10px; position: relative; }
        .logo-icon::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 10px solid var(--leaf-mint); }
        
        .step-indicator { display: flex; gap: 20px; font-size: 12px; opacity: 0.9; }
        .step.active { font-weight: 700; border-bottom: 2px solid var(--pure-white); padding-bottom: 2px; }

        .selected-summary { background-color: #2c3e50; color: white; padding: 15px 0; display: none; animation: slideDown 0.3s ease; }
        .selected-content { max-width: 1000px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .selected-label { background: var(--leaf-mint); padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; margin-right: 10px; }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }

        .search-summary-bar { background-color: var(--pure-white); padding: 15px 0; border-bottom: 1px solid #ddd; }
        .container { max-width: 1000px; margin: 0 auto; padding: 0 20px; }
        .summary-content { display: flex; justify-content: space-between; align-items: center; }
        
        .direction-badge { font-size: 12px; font-weight: 700; color: var(--leaf-sky); border: 1px solid var(--leaf-sky); padding: 3px 10px; border-radius: 20px; margin-right: 10px; text-transform: uppercase; }
        .direction-badge.inbound { color: #e67e22; border-color: #e67e22; }

        .route-info { font-size: 18px; font-weight: 700; display: flex; align-items: center; }
        .route-arrow { color: var(--leaf-mint); margin: 0 10px; font-size: 14px; }

        .date-strip { display: flex; justify-content: space-between; background: var(--pure-white); margin-top: 20px; padding: 10px; border-radius: 4px; overflow-x: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .date-card { flex: 1; min-width: 80px; text-align: center; padding: 10px 5px; cursor: pointer; border-radius: 4px; }
        .date-card:hover { background-color: #f9f9f9; }
        .date-card.active { background-color: var(--leaf-mint); color: var(--pure-white); font-weight: bold; }
        .date-card .day { font-size: 12px; margin-bottom: 5px; }
        .date-card .price { font-size: 13px; font-weight: 700; }

        .flight-list { margin-top: 20px; padding-bottom: 80px; }
        .flight-card { background-color: var(--pure-white); border-radius: 8px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid transparent; transition: 0.3s; overflow: hidden; }
        .flight-card:hover { border-color: var(--leaf-sky); transform: translateY(-2px); }
        .flight-info-row { padding: 25px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px; border-bottom: 1px solid #eee; }
        .flight-times { display: flex; align-items: center; gap: 30px; flex: 2; min-width: 250px; }
        .time-group { text-align: center; }
        .time { font-size: 24px; font-weight: 700; line-height: 1; }
        .airport { font-size: 12px; color: var(--text-light); margin-top: 5px; font-weight: 500; }
        .duration-line { flex: 1; text-align: center; position: relative; font-size: 11px; color: var(--text-light); }
        .duration-line::after { content: ''; display: block; width: 100%; height: 1px; background: #ddd; position: absolute; top: 50%; z-index: 0; }
        .duration-text { background: var(--pure-white); padding: 0 10px; position: relative; z-index: 1; }
        .flight-meta { display: flex; flex-direction: column; gap: 5px; font-size: 11px; color: var(--text-light); min-width: 80px; }
        .flight-number { font-weight: 700; color: var(--leaf-sky); }

        .fare-selection { display: flex; width: 100%; }
        .fare-box { flex: 1; padding: 20px; text-align: center; cursor: pointer; border-right: 1px solid #eee; transition: 0.2s; position: relative; }
        .fare-box:last-child { border-right: none; }
        .fare-box:hover { background-color: #fafafa; }
        .fare-box.selected { background-color: #eafbf7; }
        .fare-box.selected::before { content: '✔'; position: absolute; top: 10px; left: 10px; color: var(--leaf-mint); font-weight: bold; }
        .class-name { font-size: 12px; font-weight: 700; color: var(--text-light); text-transform: uppercase; margin-bottom: 5px; }
        .fare-price { font-size: 20px; font-weight: 700; }
        .fare-seats { font-size: 11px; color: var(--text-light); margin-top: 5px; }
        .fare-box.premium .class-name { color: #d4af37; }

        /* ローディング表示 */
        .loading { text-align: center; padding: 50px; color: var(--leaf-mint); font-weight: 700; }

        @media (max-width: 768px) {
            .flight-info-row { flex-direction: column; align-items: flex-start; }
            .flight-times { width: 100%; }
            .fare-selection { flex-direction: column; }
            .fare-box { border-right: none; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; padding: 15px; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo"><div class="logo-icon"></div>LEAF WINGS</div>
        <div class="step-indicator">
            <span class="step active">1. 便選択</span>
            <span class="step">2. お客様情報</span>
            <span class="step">3. 完了</span>
        </div>
    </header>

    <div class="selected-summary" id="outbound-summary">
        <div class="selected-content">
            <div><span class="selected-label">往路選択済</span> <span id="summary-text">---</span></div>
            <div>✔</div>
        </div>
    </div>

    <div class="search-summary-bar">
        <div class="container summary-content">
            <div class="route-info">
                <span class="direction-badge" id="direction-badge">Outbound 往路</span>
                <span id="display-from">NGO</span> 
                <span class="route-arrow">✈︎</span> 
                <span id="display-to">---</span>
                <span style="font-size: 14px; font-weight: 400; margin-left: 15px; color: #666;" id="display-date">---</span>
            </div>
            <a href="index.html" style="font-size: 12px; color: var(--leaf-mint); border: 1px solid var(--leaf-mint); padding: 5px 15px; border-radius: 20px;">検索変更</a>
        </div>
    </div>

    <div class="container">
        <div class="date-strip" id="date-strip"></div>
        <div class="flight-list" id="flight-list-container">
            <div class="loading">Searching Flights...<br>フライト情報を取得中...</div>
        </div>
    </div>

    <script>
        // ★★★ ここにコピーしたURLを貼り付けてください！ ★★★
        // 例: "https://docs.google.com/spreadsheets/d/e/2PACX-12345.../pub?output=csv"
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRaQ9icjIO6vyY3Skruj6gPPrpG9Mct58Ej36edfv-sP5NcQ9vU8LXY1H2mpEamhtmxnd2TNz_-njSN/pub?output=csv"; 

        let appState = {
            step: 1,
            tripType: 'oneway',
            outboundData: null,
            inboundData: null,
            currentFrom: '',
            currentTo: '',
            currentDate: '',
            allFlights: [] // ここにスプレッドシートのデータを入れます
        };

        // 都市データ
        const airportData = {
            'NGO': { city: '名古屋(中部)' }, 'CTS': { city: '札幌(新千歳)' }, 'SDJ': { city: '仙台' }, 'KIJ': { city: '新潟' },
            'FUK': { city: '福岡' }, 'KMJ': { city: '熊本' }, 'KMI': { city: '宮崎' }, 'MYJ': { city: '松山' }, 'OKA': { city: '沖縄(那覇)' },
            'TPE': { city: '台北' }, 'ICN': { city: 'ソウル' }, 'MNL': { city: 'マニラ' }
        };

        document.addEventListener('DOMContentLoaded', function() {
            const params = new URLSearchParams(window.location.search);
            appState.tripType = params.get('tripType') || 'oneway';
            appState.currentFrom = params.get('from') || 'NGO';
            appState.currentTo = params.get('to') || 'FUK';
            appState.currentDate = params.get('depDate') || new Date().toISOString().split('T')[0];

            // ★最初にスプレッドシートを読み込む
            fetchFlights();
        });

        function fetchFlights() {
            if(SHEET_URL === "YOUR_SHEET_URL_HERE") {
                alert("エラー：スプレッドシートのURLが設定されていません。コードを修正してください。");
                return;
            }

            // Papa Parseを使ってCSVを読み込む
            Papa.parse(SHEET_URL, {
                download: true,
                header: true,
                complete: function(results) {
                    console.log("データ取得成功:", results.data);
                    appState.allFlights = results.data; // データを保存
                    renderPage(); // 画面表示開始
                },
                error: function(err) {
                    console.error("データ取得失敗:", err);
                    document.getElementById('flight-list-container').innerHTML = '<div style="text-align:center; color:red;">データの読み込みに失敗しました。<br>URLを確認してください。</div>';
                }
            });
        }

        function renderPage() {
            document.getElementById('display-from').textContent = appState.currentFrom;
            document.getElementById('display-to').textContent = appState.currentTo;
            
            const dObj = new Date(appState.currentDate);
            const dayOfWeek = ['日','月','火','水','木','金','土'][dObj.getDay()];
            document.getElementById('display-date').textContent = `${appState.currentDate.replace(/-/g, '/')} (${dayOfWeek})`;

            const badge = document.getElementById('direction-badge');
            if (appState.step === 1) {
                badge.textContent = 'Outbound 往路';
                badge.className = 'direction-badge';
                document.getElementById('outbound-summary').style.display = 'none';
            } else {
                badge.textContent = 'Inbound 復路';
                badge.className = 'direction-badge inbound';
                document.getElementById('outbound-summary').style.display = 'block';
                document.getElementById('summary-text').textContent = 
                    `${appState.outboundData.from} ✈ ${appState.outboundData.to} / LW${appState.outboundData.id}`;
            }
            renderFlights();
            renderDateStrip();
        }

        function renderFlights() {
            const container = document.getElementById('flight-list-container');
            container.innerHTML = '';

            // ★データベース(allFlights)から、条件に合う便を検索する
            // 条件: 出発地(from) と 到着地(to) が一致するもの
            const list = appState.allFlights.filter(flight => {
                return flight.from === appState.currentFrom && flight.to === appState.currentTo;
            });

            if(list.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">該当するフライトがありません。<br>No flights available.</div>';
                return;
            }

            // フライトカードの生成
            list.forEach(flight => {
                // 所要時間計算
                const [dh, dm] = flight.dep.split(':').map(Number);
                const [ah, am] = flight.arr.split(':').map(Number);
                let dur = (ah * 60 + am) - (dh * 60 + dm);
                if(dur < 0) dur += 1440;
                const durStr = `${Math.floor(dur/60)}h ${dur%60}m`;

                // 価格計算 (CSVの price を基準にする)
                const basePrice = parseInt(flight.price);
                const std = Math.floor(basePrice * (dh<9?0.9:dh>17?1.1:1.0)); // 早朝割引などのロジックは維持
                const pre = Math.floor(std * 2.5);

                const html = `
                <div class="flight-card">
                    <div class="flight-info-row">
                        <div class="flight-times">
                            <div class="time-group"><div class="time">${flight.dep}</div><div class="airport">${appState.currentFrom}</div></div>
                            <div class="duration-line"><span class="duration-text">${durStr}</span></div>
                            <div class="time-group"><div class="time">${flight.arr}</div><div class="airport">${appState.currentTo}</div></div>
                        </div>
                        <div class="flight-meta"><span class="flight-number">LW ${flight.id}</span><span>${flight.aircraft || 'A320neo'}</span><span>Wi-Fi Free</span></div>
                    </div>
                    <div class="fare-selection">
                        <div class="fare-box" onclick="selectFlight('${flight.id}', ${std}, 'Standard')">
                            <div class="class-name">Standard</div><div class="fare-price">¥${std.toLocaleString()}</div>
                        </div>
                        <div class="fare-box premium" onclick="selectFlight('${flight.id}', ${pre}, 'Premium')">
                            <div class="class-name">Premium</div><div class="fare-price">¥${pre.toLocaleString()}</div>
                        </div>
                    </div>
                </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function selectFlight(id, price, cls) {
            const flightData = {
                id: id, price: price, class: cls,
                from: appState.currentFrom, to: appState.currentTo, date: appState.currentDate
            };

            if (appState.step === 1) {
                appState.outboundData = flightData;
                if (appState.tripType === 'round') {
                    appState.step = 2;
                    const temp = appState.currentFrom;
                    appState.currentFrom = appState.currentTo;
                    appState.currentTo = temp;
                    const params = new URLSearchParams(window.location.search);
                    appState.currentDate = params.get('retDate') || appState.currentDate;
                    window.scrollTo(0, 0);
                    renderPage();
                } else {
                    finishSelection();
                }
            } else {
                appState.inboundData = flightData;
                finishSelection();
            }
        }

        function finishSelection() {
            const p = new URLSearchParams();
            p.set('tripType', appState.tripType);
            p.set('out_id', appState.outboundData.id);
            p.set('out_price', appState.outboundData.price);
            p.set('out_class', appState.outboundData.class);
            p.set('out_date', appState.outboundData.date);
            p.set('from', appState.outboundData.from);
            p.set('to', appState.outboundData.to);
            
            if(appState.inboundData) {
                p.set('in_id', appState.inboundData.id);
                p.set('in_price', appState.inboundData.price);
                p.set('in_date', appState.inboundData.date);
            }
            
            window.location.href = `passenger.html?${p.toString()}`;
        }

        function renderDateStrip() {
            const el = document.getElementById('date-strip');
            el.innerHTML = '';
            const centerDate = new Date(appState.currentDate);
            for(let i=-2; i<=3; i++) {
                const d = new Date(centerDate);
                d.setDate(centerDate.getDate() + i);
                const m = d.getMonth()+1;
                const date = d.getDate();
                const w = ['日','月','火','水','木','金','土'][d.getDay()];
                const dayStr = `${m}/${date}(${w})`;
                const active = i===0 ? 'active' : '';
                const isWeekend = (d.getDay()===0 || d.getDay()===6);
                const priceLabel = isWeekend ? "High" : "Low";
                el.innerHTML += `<div class="date-card ${active}"><div class="day">${dayStr}</div><div class="price" style="font-size:10px;">${priceLabel}</div></div>`;
            }
        }
    </script>
</body>
</html>
